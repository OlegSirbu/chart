!function(e,t,i,o){"use strict";function s(t,i){this.element=t,this.settings=e.extend({},v,i),this._defaults=v,this._name=g,this.init()}function l(e,t){for(var i in t)e=e.replace(new RegExp("{"+i+"}","g"),t[i]);return e}function a(e){return"."+e}function r(e){return e?'<div class="{'+e+'}"></div>':'<div class="{wrapper}"></div>'}function n(e){for(var t="",i=0;i<e.length;i++)e[i].selected&&(t+=h(e[i].val,e[i].text));return t}function p(e,t){return l('<div class="{tagWrapper}"><textarea class="{selectTextarea}"></textarea><ul class="{selectTags}">{tags}</ul><div class="{placeholderText}">{text}</div></div>',{tags:n(t),text:e,placeholderText:f.placeholderText,tagWrapper:f.tagWrapper,selectTextarea:f.selectTextarea,selectTags:f.selectTags})}function h(e,t){return l('<li class="{tag}" data-value="{val}" data-text="{text}"><span class="{popoverClose}">&times;</span>{text}</li>',{text:t,val:e,tag:f.tag,popoverClose:f.popoverClose})}function c(e,t){return l('<li data-value="{val}" data-text="{text}">{text}</li>',{val:e,text:t})}function d(){return l('<li class="{placeholder}"><div><input type="text" readonly="true"></div></li>',{placeholder:f.placeholder})}function u(e,t){return l('<div class="{popoverSelect} {top}">'+(t.showTitle?'<h3 class="{selectTitle}">{title}</h3>':"")+'<div class="{popoverBody}"><ul class="{selectList}">{list}</ul></div><div class="{arrow}"></div></div>',{title:t.title,list:e,arrow:f.arrow,popoverSelect:f.popoverSelect,popoverBody:f.popoverBody,selectList:f.selectList,top:t.position,selectTitle:f.selectTitle})}var g="popSelect",v={position:"top",showTitle:!0,autoIncrease:!0,title:"Select Multiple Options",debug:!1,maxAllowed:0,placeholderText:"Click to Add Values",autofocus:!1},f={tag:"tag",arrow:"arrow",selectWrapper:"popover-select-wrapper",tagWrapper:"popover-tag-wrapper",popoverSelect:"popover-select",popoverBody:"popover-select-body",selectTextarea:"popover-select-textarea",selectTags:"popover-select-tags",popoverClose:"popSelect-close",selectList:"popover-select-list",popoverDisabled:"disabled",placeholder:"placeholder",placeholderInput:"placeholder input",placeholderText:"placeholder-text",selectTitle:"popover-select-title",top:"top"},x={popoverGenerated:"PopSelect Code Generated",closeClicked:"Close button clicked",noElem:"No element to be removed",unSupported:"Not Supported",posChanged:"Position changed"},$={option:"option",blur:"blur",click:"click",mousedown:"mousedown",li:"li",attrVal:"data-value",attrText:"data-text",body:"BODY"};e.extend(s.prototype,{init:function(){var t=this;this.$elem=e(this.element),this.$options=this.$elem.children($.option).map(function(t,i){return{val:e(i).val(),text:e(i).text(),selected:e(i).attr("selected")}}),this.$elem.wrap(l(r(),{wrapper:f.selectWrapper}));var i=this.getPosition(this.$elem);this.elemPos=i,this.$elem.parent(a(f.selectWrapper)).css({width:this.settings.width||i.width,height:i.height});var o=this.generatePopover(this.$options);t.log(x.popoverGenerated,o),this.$elem.after(o),this.$popover=this.$elem.next(a(f.popoverSelect)),this.$popover.css({top:0,left:0}),this.$elem.after(p(this.settings.placeholderText,this.$options)),this.$tagWrapper=this.$elem.next(a(f.tagWrapper)),this.baseHeight=this.$tagWrapper.height(),this.$inputTagField=this.$tagWrapper.find(a(f.selectTextarea)),this.$inputTagField.on($.blur,function(){t.$popover.hide()}),this.$tags=this.$tagWrapper.find(a(f.selectTags)),this.$tags.on($.click,this.initializePopover.bind(this)),this.$tags.next(a(f.placeholderText)).on($.click,this.initializePopover.bind(this)),this.$tags.on($.click,a(f.popoverClose),function(){t.inputToPopover(e(this))}),this.$popover.find(a(f.selectList)).on($.mousedown,function(e){e.preventDefault()}).on($.click,$.li,function(){t.popoverToInput(e(this))}),this.$elem.hide(),this.checkNumberOfTags(),this.changeSize(),this.$elem.trigger("popselect:init"),this.settings.autofocus&&this.initializePopover()},inputToPopover:function(e){var t=e.parent();this.log(x.closeClicked,t);var i=t.attr($.attrVal),o=t.attr($.attrText);this.appendToPopup(i,o),t.remove(),this.setPlaceholder(),this.focus(),this.changeSize(),this.checkNumberOfTags(),this.$elem.trigger("popselect:remove",[i,o])},enablePopover:function(){this.$popover.find(a(f.selectList)+" li").removeClass(f.popoverDisabled)},disablePopover:function(){this.$popover.find(a(f.selectList)+" li").addClass(f.popoverDisabled)},checkNumberOfTags:function(){var e=this.$tags.find(a(f.tag)).length;0===e?this.enablePlaceHolderText():this.disablePlaceHolderText(),0!==this.settings.maxAllowed&&(this.settings.maxAllowed>e?this.enablePopover():this.disablePopover()),this.syncWithSelect()},popoverToInput:function(e){var t=e.attr($.attrVal),i=e.text(),o=h(t,i);this.$tags.append(o),e.remove(),this.setPlaceholder(),this.focus(),this.popoverShow(),this.changePosition(),this.changeSize(),this.checkNumberOfTags(),this.$elem.trigger("popselect:add",[t,i])},popoverShow:function(){this.$popover.find(a(f.selectList)+" li").length?this.$popover.show():this.$popover.hide()},initializePopover:function(){this.popoverShow(),this.changePosition(),this.setPlaceholder(),this.focus()},enablePlaceHolderText:function(){this.$tags.next(a(f.placeholderText)).show()},disablePlaceHolderText:function(){this.$tags.next(a(f.placeholderText)).hide()},focus:function(){var e=this;this.$tags.find(a(f.placeholderInput)).focus(),this.$tags.find(a(f.placeholderInput)).on($.blur,function(){e.$popover.hide()})},setPlaceholder:function(){this.$tags.children(a(f.placeholder)).length&&this.$tags.children(a(f.placeholder)).remove(),this.$tags.append(d()),this.disableInput()},disableInput:function(){var t=this;this.$tags.find(a(f.placeholderInput)).keyup(function(i){e(this).val(""),(8===i.which||46===i.which||i.ctrlKey&&88===i.which)&&t.removeLastElem()})},changeSize:function(){if(this.settings.autoIncrease){var t=0,i=this.settings.width||this.elemPos.width;this.$tags.find(a(f.tag)).each(function(i,o){t+=e(o).outerWidth()+20});var o=Math.floor(t/i);this.$tags.height((o+1)*this.baseHeight)}},removeLastElem:function(){var t=this.$tags.find(a(f.tag));if(t.length){var i=e(t[t.length-1]),o=i.attr($.attrVal),s=i.attr($.attrText);this.appendToPopup(o,s),i.remove(),this.changePosition(),this.setPlaceholder(),this.focus(),this.changeSize(),this.checkNumberOfTags()}else this.log(x.noElem)},setTitle:function(e){this.settings.showTitle&&this.$popover.find(a(f.selectTitle)).text(e)},getPosition:function(o){o=o||this.$element;var s=o[0],l=s.tagName===$.body,a=s.getBoundingClientRect();if(null==a.width){var r=a.right-a.left,n=a.bottom-a.top;a=e.extend({},a,{width:r,height:n})}var p=l?{top:0,left:0}:o.offset(),h={scroll:l?i.documentElement.scrollTop||i.body.scrollTop:o.scrollTop()},c=l?{width:e(t).width(),height:e(t).height()}:null;return e.extend({},a,h,c,p)},syncWithSelect:function(){var t=this.$tags.find(a(f.tag)).map(function(t,i){return e(i).attr("data-value")}).toArray();this.$elem.children($.option).each(function(i,o){t.indexOf(e(o).val())<0?e(o).removeAttr("selected"):e(o).attr("selected","selected")})},appendToPopup:function(e,t){var i=c(e,t);this.$popover.find(a(f.selectList)).append(i)},generatePopover:function(e){for(var t="",i=0;i<e.length;i++)e[i].selected||(t+=c(e[i].val,e[i].text));var o=u(t,this.settings);return o},changePosition:function(){var e,t=this.getPosition(this.$popover),i=this.getPosition(this.$tagWrapper),o=(this.settings.width||this.elemPos.width)/2-t.width/2;e="top"===this.settings.position?-t.height:i.height,this.log("popPos.width",t.width),this.log(x.posChanged,e,o),this.$popover.css({top:e,left:o})},log:function(){this.settings.debug&&console.log.apply(console,arguments)}}),e.fn.popSelect=function(t){return"string"!=typeof t?this.each(function(){e.data(this,"plugin_"+g)||e.data(this,"plugin_"+g,new s(this,t))}):"value"===t?this.next(a(f.tagWrapper)).find(a(f.tag)).map(function(t,i){return e(i).attr($.attrVal)}):void console.warn(x.unSupported)}}(jQuery,window,document);